<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëª©ì¼ì¤‘ ì§„í•™ í˜„í™© í†µí•© ìƒì„±ê¸° (V19)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* PDF ìŠ¤íƒ€ì¼ì˜ ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ */
        .preview-area {
            font-family: 'Malgun Gothic', 'Noto Sans KR', sans-serif;
            background: white;
            padding: 40px;
            border: 1px solid #ddd;
            overflow-x: auto;
            min-height: 500px;
        }

        /* í…Œì´ë¸” ë””ìì¸ */
        table.status-table {
            width: 100%;
            border-collapse: collapse;
            text-align: center;
            border: 2px solid #000;
            font-size: 10pt;
            color: #000;
        }
        .status-table th, .status-table td {
            border: 1px solid #000;
            padding: 6px 4px;
            vertical-align: middle;
            white-space: nowrap;
        }
        .status-table thead th {
            background-color: #f8f9fa;
            font-weight: bold;
            border-bottom: 2px solid #000;
            height: 35px;
        }
        .bg-group { background-color: #e9ecef !important; }
        .thick-top { border-top: 2px solid #000 !important; }
        .thick-right { border-right: 2px solid #000 !important; }

        /* í†µê³„ ìš”ì•½ */
        .stats-container {
            margin-top: 30px;
            font-family: 'Malgun Gothic', sans-serif;
            border-top: 2px solid #000;
            padding-top: 20px;
            font-size: 11pt;
            line-height: 1.6;
        }
        .stats-header { font-size: 13pt; font-weight: bold; text-decoration: underline; margin-bottom: 15px; }
        .stats-row { margin-bottom: 8px; }
        .stats-label { display: inline-block; font-weight: bold; width: 160px; }
        .stats-school-list { margin-left: 10px; color: #444; font-size: 10pt; }
        .stats-total-box {
            margin-top: 20px; padding-top: 15px;
            border-top: 1px solid #aaa; font-weight: bold; font-size: 12pt;
        }

        .tab-btn { transition: all 0.2s; }
        .tab-active { background-color: #4f46e5; color: white; border-color: #4f46e5; }
        .tab-inactive { background-color: white; color: #4b5563; border-color: #d1d5db; hover:bg-gray-50; }
        .input-group { @apply border rounded-md p-4 bg-gray-50 mb-4; }
    </style>
</head>
<body class="bg-gray-100 p-8">

    <div class="max-w-7xl mx-auto space-y-6">
        
        <div class="flex space-x-4 mb-4">
            <button onclick="switchTab('early')" id="tab-early" class="tab-btn tab-active flex-1 py-4 px-6 rounded-lg font-bold text-lg border-2 shadow-sm">
                âš¡ ì „ê¸° ê³ ë“±í•™êµ
            </button>
            <button onclick="switchTab('late')" id="tab-late" class="tab-btn tab-inactive flex-1 py-4 px-6 rounded-lg font-bold text-lg border-2 shadow-sm">
                ğŸ‚ í›„ê¸° ê³ ë“±í•™êµ
            </button>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md border-t-4 border-indigo-600">
            <h1 id="pageTitle" class="text-2xl font-bold mb-2 text-gray-800">ëª©ì¼ì¤‘ ì§„í•™ í˜„í™© ìƒì„±ê¸° (V19)</h1>
            <p id="pageDesc" class="text-gray-600 text-sm mb-6">
                êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ URLì„ ì…ë ¥í•˜ê±°ë‚˜ CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”. (í›„ê¸°ê³ ëŠ” 'í•©' íŒì • í•™ìƒë§Œ í•„í„°ë§)
            </p>
            
            <div class="flex space-x-4 mb-4 text-sm font-bold text-gray-700">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="radio" name="sourceType" value="file" checked onclick="toggleSource('file')">
                    <span>ğŸ“ íŒŒì¼ ì—…ë¡œë“œ</span>
                </label>
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="radio" name="sourceType" value="url" onclick="toggleSource('url')">
                    <span>ğŸŒ êµ¬ê¸€ ì‹œíŠ¸ URL</span>
                </label>
            </div>

            <div id="fileSection" class="input-group">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">ì¸ì½”ë”© ì„ íƒ</label>
                        <select id="encodingSelect" class="block w-full border-gray-300 rounded-md shadow-sm p-2 border">
                            <option value="utf-8" selected>UTF-8 (êµ¬ê¸€ ì‹œíŠ¸/ìµœì‹  ì—‘ì…€)</option>
                            <option value="euc-kr">EUC-KR (êµ¬ë²„ì „ ì—‘ì…€)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">CSV íŒŒì¼ ì„ íƒ</label>
                        <input type="file" id="csvInput" accept=".csv" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 cursor-pointer"/>
                    </div>
                </div>
            </div>

            <div id="urlSection" class="input-group hidden">
                <label class="block text-sm font-bold text-gray-700 mb-1">êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì£¼ì†Œ</label>
                <div class="flex gap-2">
                    <input type="text" id="sheetUrl" class="flex-1 border p-2 rounded" placeholder="https://docs.google.com/spreadsheets/d/.../edit?gid=...">
                    <button onclick="fetchFromUrl()" class="bg-blue-600 text-white px-4 py-2 rounded font-bold hover:bg-blue-700">ë°ì´í„° ê°€ì ¸ì˜¤ê¸°</button>
                </div>
                <p class="text-xs text-red-500 mt-2">* ì£¼ì˜: ë¸Œë¼ìš°ì € ë³´ì•ˆ(CORS)ìœ¼ë¡œ ì¸í•´ ì‹¤íŒ¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì‹¤íŒ¨ ì‹œ ì‹œíŠ¸ë¥¼ <b>[íŒŒì¼ > ê³µìœ  > ì›¹ì— ê²Œì‹œ]</b> í•˜ê±°ë‚˜ ì•„ë˜ íŒŒì´ì¬ ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.</p>
            </div>

            <div class="flex flex-wrap gap-3 justify-end mt-4">
                <button onclick="downloadExcel()" id="excelBtn" class="hidden px-6 py-2.5 bg-green-700 text-white font-bold rounded shadow hover:bg-green-800 transition flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                    <span>ì—‘ì…€ íŒŒì¼(.xlsx) ì €ì¥</span>
                </button>
                <button onclick="copyTable()" id="copyBtn" class="hidden px-6 py-2.5 bg-blue-600 text-white font-bold rounded shadow hover:bg-blue-700 transition flex items-center gap-2">
                    <span>ğŸ“‹ í‘œ ë³µì‚¬í•˜ê¸°</span>
                </button>
                <button onclick="downloadHtmlFile()" id="downloadBtn" class="hidden px-6 py-2.5 bg-indigo-600 text-white font-bold rounded shadow hover:bg-indigo-700 transition flex items-center gap-2">
                    <span>HTML ë‹¤ìš´ë¡œë“œ</span>
                </button>
            </div>
        </div>

        <div id="previewContainer" class="hidden">
            <h3 class="text-lg font-bold mb-2 text-gray-700">ë¯¸ë¦¬ë³´ê¸°</h3>
            <div class="preview-area" id="tableOutput"></div>
        </div>
    </div>

    <script>
        let currentMode = 'early';
        let generatedHtmlContent = "";
        
        // ê¸°ë³¸ URL ì„¤ì •
        const DEFAULT_URLS = {
            early: "https://docs.google.com/spreadsheets/d/1I_Cy5TZEnG0GmoThLPJJR7ZrXxUgXzsDDzu2zOtmjQI/edit?gid=214657398",
            late: "https://docs.google.com/spreadsheets/d/1I_Cy5TZEnG0GmoThLPJJR7ZrXxUgXzsDDzu2zOtmjQI/edit?gid=1675631175"
        };

        function switchTab(mode) {
            currentMode = mode;
            const earlyBtn = document.getElementById('tab-early');
            const lateBtn = document.getElementById('tab-late');
            const title = document.getElementById('pageTitle');
            const desc = document.getElementById('pageDesc');
            
            // íƒ­ ìŠ¤íƒ€ì¼
            if (mode === 'early') {
                earlyBtn.classList.replace('tab-inactive', 'tab-active');
                lateBtn.classList.replace('tab-active', 'tab-inactive');
                title.innerText = "ëª©ì¼ì¤‘ ì „ê¸°ê³  ì§„í•™ í˜„í™© ìƒì„±ê¸° (V19)";
            } else {
                earlyBtn.classList.replace('tab-active', 'tab-inactive');
                lateBtn.classList.replace('tab-inactive', 'tab-active');
                title.innerText = "ëª©ì¼ì¤‘ í›„ê¸°ê³  ì§„í•™ í˜„í™© ìƒì„±ê¸° (V19)";
            }
            
            // URL ì…ë ¥ì°½ ì—…ë°ì´íŠ¸
            document.getElementById('sheetUrl').value = DEFAULT_URLS[mode];
            
            // í™”ë©´ ì´ˆê¸°í™”
            document.getElementById('previewContainer').classList.add('hidden');
            document.getElementById('excelBtn').classList.add('hidden');
            document.getElementById('copyBtn').classList.add('hidden');
            document.getElementById('downloadBtn').classList.add('hidden');
        }

        function toggleSource(type) {
            if(type === 'file') {
                document.getElementById('fileSection').classList.remove('hidden');
                document.getElementById('urlSection').classList.add('hidden');
            } else {
                document.getElementById('fileSection').classList.add('hidden');
                document.getElementById('urlSection').classList.remove('hidden');
                document.getElementById('sheetUrl').value = DEFAULT_URLS[currentMode];
            }
        }

        // --- íŒŒì¼ ì²˜ë¦¬ ---
        document.getElementById('csvInput').addEventListener('change', handleFileSelect);
        function handleFileSelect(evt) {
            const file = evt.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const encoding = document.getElementById('encodingSelect').value;
                const decoder = new TextDecoder(encoding);
                const text = decoder.decode(e.target.result);
                processRawData(text);
            };
            reader.readAsArrayBuffer(file);
        }

        // --- URL ì²˜ë¦¬ ---
        async function fetchFromUrl() {
            let url = document.getElementById('sheetUrl').value;
            // edit URL -> export URL ë³€í™˜
            if (url.includes('/edit')) {
                url = url.replace('/edit', '/export') + '&format=csv';
            }
            
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error("ë„¤íŠ¸ì›Œí¬ ì‘ë‹µ ì‹¤íŒ¨ (CORS ë¬¸ì œì¼ ìˆ˜ ìˆìŒ)");
                const text = await response.text();
                processRawData(text);
            } catch (err) {
                alert("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨!\n\nì›ì¸: " + err.message + "\n\ní•´ê²°ì±…:\n1. íŒŒì¼ ë©”ë‰´ > ê³µìœ  > ì›¹ì— ê²Œì‹œ í›„ í•´ë‹¹ URL ì‚¬ìš©\n2. ë˜ëŠ” íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ì—¬ ì—…ë¡œë“œ ë°©ì‹ ì‚¬ìš©");
            }
        }

        function processRawData(csvText) {
            const workbook = XLSX.read(csvText, {type: 'string'});
            const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1});
            
            if (currentMode === 'early') processEarlyData(rows);
            else processLateData(rows);
        }

        // --- ë°ì´í„° ë¡œì§ ---
        function findIndices(rows, k1, k2, k3) {
            let res = { headerRow: -1, sci: {}, arts: {}, voc: {} };
            const defaultIdx = { name: -1, class: -1, gender: -1, school: -1, dept: -1, pass: -1 };
            Object.assign(res.sci, defaultIdx); Object.assign(res.arts, defaultIdx); Object.assign(res.voc, defaultIdx);

            for(let i=0; i<Math.min(rows.length, 25); i++) { // ê²€ìƒ‰ ë²”ìœ„ 25í–‰ìœ¼ë¡œ í™•ëŒ€
                const rowStr = (rows[i]||[]).join(' ');
                if(rowStr.includes('ì´ë¦„') || rowStr.includes('ì„±ëª…')) {
                    res.headerRow = i;
                    let cols = [];
                    rows[i].forEach((c, idx) => { if(String(c).includes('ì´ë¦„') || String(c).includes('ì„±ëª…')) cols.push(idx); });
                    
                    if(cols[0]!==undefined) setIdxAndPass(res.sci, cols[0], rows[i]);
                    if(cols[1]!==undefined) setIdxAndPass(res.arts, cols[1], rows[i]);
                    if(cols[2]!==undefined) setIdxAndPass(res.voc, cols[2], rows[i]);
                    break;
                }
            }
            return res;
        }

        function setIdxAndPass(obj, nameIdx, headerRow) {
            obj.name = nameIdx; obj.class = nameIdx - 1; obj.gender = nameIdx + 1; obj.school = nameIdx + 2; obj.dept = nameIdx + 3;
            // í•©ë¶ˆ ì»¬ëŸ¼ íƒìƒ‰ ë²”ìœ„ í™•ëŒ€ (í•™êµëª… ë’¤ 1~5ì¹¸)
            for (let offset = 1; offset <= 5; offset++) {
                let checkIdx = obj.school + offset;
                let headerTxt = String(headerRow[checkIdx] || "");
                if (['í•©', 'ë¶ˆ', 'ë‹¹ë½', 'í•©ê²©', 'ê²°ê³¼'].some(k => headerTxt.includes(k))) {
                    obj.pass = checkIdx;
                    break;
                }
            }
        }

        function processEarlyData(rows) {
            const classes = {};
            for (let i = 1; i <= 15; i++) classes[i] = { gifted: [], sci: [], arts: [], voc: [] };
            let indices = findIndices(rows); 
            
            const startRow = indices.headerRow + 1;
            let counts = { gifted: 0, sci: 0, arts: 0, voc: 0 };

            for (let i = startRow; i < rows.length; i++) {
                const row = rows[i]; if (!row) continue;
                // ê³¼í•™ê³ 
                if (indices.sci.name !== -1 && row[indices.sci.name]) {
                    const cls = parseClass(row[indices.sci.class]);
                    if (cls && classes[cls]) { classes[cls].sci.push(createStudent(row, indices.sci)); counts.sci++; }
                }
                // ì˜ˆê³ 
                if (indices.arts.name !== -1 && row[indices.arts.name]) {
                    const cls = parseClass(row[indices.arts.class]);
                    if (cls && classes[cls]) {
                        let s = createStudent(row, indices.arts);
                        s.school = cleanArtsSchoolName(s.school);
                        classes[cls].arts.push(s); counts.arts++;
                    }
                }
                // íŠ¹ì„±í™”
                if (indices.voc.name !== -1 && row[indices.voc.name]) {
                    const cls = parseClass(row[indices.voc.class]);
                    if (cls && classes[cls]) { classes[cls].voc.push(createStudent(row, indices.voc, true)); counts.voc++; }
                }
            }
            
            const columns = [
                { id: 'gifted', label: 'ì˜ì¬í•™êµ', showTable: counts.gifted > 0, dataKey: 'gifted' },
                { id: 'sci', label: 'ê³¼í•™ê³ ', showTable: counts.sci > 0, dataKey: 'sci' },
                { id: 'arts', label: 'ì˜ˆì²´ë¯¸ê³ ', showTable: counts.arts > 0, dataKey: 'arts' },
                { id: 'voc', label: 'íŠ¹ì„±í™”ê³ ', showTable: counts.voc > 0, dataKey: 'voc', hasDept: true }
            ];
            renderTable("2026í•™ë…„ë„ ëª©ì¼ì¤‘ ì „ê¸°ê³  ì§„í•™ í˜„í™©", "ì „ê¸°", classes, columns);
        }

        function processLateData(rows) {
            const classes = {};
            for (let i = 1; i <= 15; i++) classes[i] = { jasa: [], foreign: [], etc: [] };
            let indices = findIndices(rows);
            let counts = { jasa: 0, foreign: 0, etc: 0 };

            const startRow = indices.headerRow + 1;
            for (let i = startRow; i < rows.length; i++) {
                const row = rows[i]; if (!row) continue;

                // í•©ë¶ˆ ì²´í¬ (í•„ìˆ˜)
                const isPass = (idxInfo, r) => {
                    if (idxInfo.pass === -1) return true; // í•©ë¶ˆ ì»¬ëŸ¼ ì—†ìœ¼ë©´ í†µê³¼
                    const v = String(r[idxInfo.pass] || "").trim();
                    return v.includes("í•©"); // "í•©", "í•©ê²©", "ì¶”ê°€í•©ê²©" ë“± í¬í•¨ ì‹œ
                };

                // ìì‚¬ê³  (Group 1 ìœ„ì¹˜)
                if (indices.sci.name !== -1 && row[indices.sci.name]) {
                    const cls = parseClass(row[indices.sci.class]);
                    if (cls && classes[cls] && isPass(indices.sci, row)) {
                        classes[cls].jasa.push(createStudent(row, indices.sci)); counts.jasa++;
                    }
                }
                // ì™¸ê³  (Group 2 ìœ„ì¹˜)
                if (indices.arts.name !== -1 && row[indices.arts.name]) {
                    const cls = parseClass(row[indices.arts.class]);
                    if (cls && classes[cls] && isPass(indices.arts, row)) {
                        classes[cls].foreign.push(createStudent(row, indices.arts)); counts.foreign++;
                    }
                }
                // ì¼ë°˜ê³  (Group 3 ìœ„ì¹˜)
                if (indices.voc.name !== -1 && row[indices.voc.name]) {
                    const cls = parseClass(row[indices.voc.class]);
                    if (cls && classes[cls] && isPass(indices.voc, row)) {
                        classes[cls].etc.push(createStudent(row, indices.voc, true)); counts.etc++;
                    }
                }
            }

            const columns = [
                { id: 'jasa', label: 'ìì‚¬ê³ ', showTable: counts.jasa > 0, dataKey: 'jasa' },
                { id: 'foreign', label: 'ì™¸ê³ /êµ­ì œê³ ', showTable: counts.foreign > 0, dataKey: 'foreign' },
                { id: 'etc', label: 'ë¹„í‰ì¤€í™”ê³  / ì¤‘ì í•™êµ', showTable: counts.etc > 0, dataKey: 'etc' }
            ];
            renderTable("2026í•™ë…„ë„ ëª©ì¼ì¤‘ í›„ê¸°ê³  ì§„í•™ í˜„í™©", "í›„ê¸°", classes, columns);
        }

        // --- ë Œë”ë§ ---
        function renderTable(title, typeStr, classes, columns) {
            const today = new Date().toISOString().slice(0,10);
            
            // í†µê³„
            const stats = {};
            columns.forEach(col => stats[col.id] = { m:0, f:0, schools:{} });
            let totalM=0, totalF=0;

            for(let i=1; i<=15; i++) {
                columns.forEach(col => {
                    const list = classes[i][col.dataKey] || [];
                    list.forEach(s => {
                        if(s.gender==='ë‚¨') { stats[col.id].m++; totalM++; } else { stats[col.id].f++; totalF++; }
                        const sn = normalizeSchoolName(s.school);
                        if(sn) stats[col.id].schools[sn] = (stats[col.id].schools[sn]||0)+1;
                    });
                });
            }

            // í—¤ë”
            let h1 = `<tr><th rowspan="2" class="thick-right" style="width:50px;">í•™ë°˜</th>`;
            let h2 = `<tr>`;
            columns.forEach(col => {
                if(col.showTable) {
                    h1 += `<th colspan="${col.hasDept?4:3}" class="bg-group thick-right">${col.label}</th>`;
                    h2 += `<th style="width:70px;">ì´ë¦„</th><th style="width:40px;">ì„±ë³„</th>`;
                    if(col.hasDept) h2 += `<th>í•™êµëª…</th><th class="thick-right">í•™ê³¼</th>`;
                    else h2 += `<th class="thick-right">í•™êµëª…</th>`;
                }
            });
            h1 += `</tr>`; h2 += `</tr>`;

            // ë³¸ë¬¸
            let tbody = '';
            for(let i=1; i<=15; i++) {
                let maxRows = 1;
                columns.forEach(col => { if(col.showTable) maxRows = Math.max(maxRows, classes[i][col.dataKey].length); });
                
                for(let r=0; r<maxRows; r++) {
                    const bc = r===0 ? 'thick-top' : '';
                    tbody += `<tr>`;
                    if(r===0) tbody += `<td rowspan="${maxRows}" class="${bc} thick-right font-bold">3-${i}</td>`;
                    
                    columns.forEach(col => {
                        if(col.showTable) {
                            const s = classes[i][col.dataKey][r] || {};
                            tbody += `<td class="${bc}">${s.name||''}</td><td class="${bc}">${s.gender||''}</td>`;
                            if(col.hasDept) tbody += `<td class="${bc}">${s.school||''}</td><td class="${bc} thick-right">${s.dept||''}</td>`;
                            else tbody += `<td class="${bc} thick-right">${s.school||''}</td>`;
                        }
                    });
                    tbody += `</tr>`;
                }
            }

            // í‘¸í„°
            let tfoot = `<tfoot><tr class="thick-top bg-gray-50 font-bold"><td class="thick-right">ë‚¨</td>`;
            columns.forEach(col => { if(col.showTable) tfoot += `<td colspan="${col.hasDept?4:3}" class="thick-right">${stats[col.id].m}ëª…</td>`; });
            tfoot += `</tr><tr class="bg-gray-50 font-bold"><td class="thick-right">ì—¬</td>`;
            columns.forEach(col => { if(col.showTable) tfoot += `<td colspan="${col.hasDept?4:3}" class="thick-right">${stats[col.id].f}ëª…</td>`; });
            tfoot += `</tr><tr class="thick-top bg-group font-bold border-b-2 border-black"><td class="thick-right">ê³„</td>`;
            columns.forEach(col => { if(col.showTable) tfoot += `<td colspan="${col.hasDept?4:3}" class="thick-right">${stats[col.id].m + stats[col.id].f}ëª…</td>`; });
            tfoot += `</tr></tfoot>`;

            // ìš”ì•½
            let summary = `<div class="stats-container"><div class="stats-header">í†µê³„ ìš”ì•½</div>`;
            columns.forEach(col => {
                const s = stats[col.id];
                const list = Object.keys(s.schools).sort().map(n => `${n}: ${s.schools[n]}ëª…`).join(', ');
                summary += `<div class="stats-row"><span class="stats-label">${col.label}:</span> <span>ì´ ${s.m+s.f}ëª… (ë‚¨: ${s.m}ëª…, ì—¬: ${s.f}ëª…)</span>${list ? `<div class="stats-school-list">â”” ${list}</div>` : ''}</div>`;
            });
            summary += `<div class="stats-total-box">${typeStr}ê³  ì´ ì§„í•™ ì¸ì›: ì´ ${totalM+totalF}ëª… (ë‚¨: ${totalM}ëª…, ì—¬: ${totalF}ëª…)</div></div>`;

            // *ì¤‘ìš” ë³€ê²½* í…Œì´ë¸”ì— id='dataTable' ë¶€ì—¬ (ì—‘ì…€ ë‹¤ìš´ë¡œë“œìš©)
            const fullHtml = `<div style="font-family:'Malgun Gothic';"><h2 style="text-align:center;font-size:20pt;font-weight:bold;margin-bottom:20px;">${title}</h2><p style="text-align:right;font-size:10pt;">(ê¸°ì¤€: ${today} ìµœì¢… í•©ë¶ˆ)</p><table id="dataTable" class="status-table"><thead>${h1}${h2}</thead><tbody>${tbody}</tbody>${tfoot}</table>${summary}</div>`;
            document.getElementById('tableOutput').innerHTML = fullHtml;
            finalize(fullHtml, title);
        }

        // ìœ í‹¸
        function createStudent(row, idxs, hasDept=false) {
            return {
                name: cleanStr(row[idxs.name]),
                gender: getGender(row[idxs.gender]),
                school: cleanStr(row[idxs.school]),
                dept: hasDept ? cleanStr(row[idxs.dept]) : ''
            };
        }
        function cleanStr(s) { return s ? String(s).trim() : ''; }
        function getGender(s) { return (s&&s.includes('ë‚¨'))?'ë‚¨':(s&&s.includes('ì—¬'))?'ì—¬':''; }
        function parseClass(v) { if(!v) return null; const s=String(v); if(s.includes('-')) return parseInt(s.split('-')[1]); const m=s.match(/\d+/g); return m?parseInt(m[m.length-1]):null; }
        function normalizeSchoolName(n) { return n?n.split('(')[0].trim():''; }
        function cleanArtsSchoolName(n) { let s=normalizeSchoolName(n); const m=['ë¯¸ìˆ ','ìŒì•…','ë¬´ìš©','ì—°ê·¹','ì˜í™”']; for(let k of m) {if(s.indexOf(k)>1) return s.substring(0, s.indexOf(k));} return s.split(' ')[0]; }

        function finalize(html, title) {
            document.getElementById('previewContainer').classList.remove('hidden');
            document.getElementById('excelBtn').classList.remove('hidden');
            document.getElementById('copyBtn').classList.remove('hidden');
            document.getElementById('downloadBtn').classList.remove('hidden');
            generatedHtmlContent = `<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><title>${title}</title><style>body{padding:20px;}${document.querySelector('style').innerHTML}.tab-btn,.bg-white{display:none;}#tableOutput{display:block;}</style></head><body>${html}</body></html>`;
        }
        function copyTable() {
            const r = document.createRange(); r.selectNode(document.getElementById('tableOutput'));
            window.getSelection().removeAllRanges(); window.getSelection().addRange(r);
            document.execCommand('copy'); alert('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
        function downloadHtmlFile() {
            if(!generatedHtmlContent) return;
            const b = new Blob([generatedHtmlContent], {type:'text/html'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(b);
            a.download = `ëª©ì¼ì¤‘_${currentMode}_ì§„í•™í˜„í™©.html`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (V19 ê¸°ëŠ¥)
        function downloadExcel() {
            const table = document.getElementById('dataTable'); 
            if (!table) { alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }

            // ì›Œí¬ë¶ ìƒì„±
            const wb = XLSX.utils.book_new();
            
            // í…Œì´ë¸”ì„ ì‹œíŠ¸ë¡œ ë³€í™˜ (raw:true ì˜µì…˜ìœ¼ë¡œ í…ìŠ¤íŠ¸ ê·¸ëŒ€ë¡œ ìœ ì§€)
            const ws = XLSX.utils.table_to_sheet(table, {raw: true});

            // ì‹œíŠ¸ ì¶”ê°€
            XLSX.utils.book_append_sheet(wb, ws, "ì§„í•™í˜„í™©");

            // íŒŒì¼ ì €ì¥
            const dateStr = new Date().toISOString().slice(0,10);
            XLSX.writeFile(wb, `ëª©ì¼ì¤‘_${currentMode}_ì§„í•™í˜„í™©_${dateStr}.xlsx`);
        }
        
        // ì´ˆê¸°í™”
        switchTab('early');
    </script>
</body>
</html>